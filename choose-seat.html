<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Choose Seat Movie</title>
    <link rel="stylesheet" href="css/choose-seat.css">
    <link rel="stylesheet" href="css/notification.css">
</head>
<body>
    <div class="movie-container">
        <label>B·∫°n ƒëang ƒë·∫∑t v√© cho phim:</label>
        <h2 id="movieName" style="color:white; margin-top:5px;"></h2>
        
        <!-- Movie Information Section -->
        <div id="movieInfoSection" style="color:#00b7ff; margin-top:15px; font-size:14px; padding: 15px; background: rgba(0, 183, 255, 0.1); border-radius: 5px; display: none;">
            <div><strong>Th·ªÉ lo·∫°i:</strong> <span id="movieGenre"></span></div>
            <div><strong>ƒê·∫°o di·ªÖn:</strong> <span id="movieDirector"></span></div>
            <div><strong>Th·ªùi l∆∞·ª£ng:</strong> <span id="movieDuration"></span> ph√∫t</div>
            <div><strong>ƒê√°nh gi√°:</strong> <span id="movieRating"></span>/5</div>
            <div style="margin-top: 10px; border-top: 1px solid #00b7ff; padding-top: 10px;">
                <div><strong>Ph√≤ng chi·∫øu:</strong> <span id="roomNumber" style="color: #ffff00; font-weight: bold;"></span></div>
                <div><strong>Su·∫•t chi·∫øu:</strong> <span id="showingInfo"></span></div>
                <div><strong>Gi√° v√©:</strong> <span id="ticketPrice" style="color: #ffff00; font-weight: bold;"></span></div>
            </div>
        </div>
        
        <p id="ticketQuantity" style="color:#00b7ff; margin-top:10px; font-size:16px;"></p>

        
        <ul class="showcase">
            <li>
                <div class="seat"></div>
                <small>C√≥ s·∫µn</small>
            </li>
            <li>
                <div class="seat selected"></div>
                <small>ƒê√£ ch·ªçn</small>
            </li>
            <li>
                <div class="seat occupied"></div>
                <small>ƒê√£ c√≥ ng∆∞·ªùi ƒë·∫∑t</small>
            </li>
        </ul>
    </div>
    <div class="container">
        <div class="screen"></div>
        <div id="seatsContainer">
            <p style="color: white; text-align: center;">ƒêang t·∫£i gh·∫ø...</p>
        </div>
        <div id="debugPanel" style="color: #0f0; font-size: 12px; margin-top: 20px; padding: 10px; background: rgba(0,0,0,0.5); border-radius: 5px; max-width: 600px; display: none;">
            <p>Debug: <span id="debugText">Loading...</span></p>
        </div>
    </div>
    <p class="text">
        B·∫°n ƒë√£ ch·ªçn <span id="count">0</span> / <span id="maxCount">0</span> ch·ªó
    </p>
    <div class="action-buttons" style="margin-top: 20px; display: flex; gap: 20px; justify-content: center;">
    
        <button id="confirmBtn" 
            style="padding: 12px 25px; background:#00b7ff; border:none; border-radius:6px;
                font-size:16px; color:white; cursor:pointer; font-weight:bold;">
            X√ÅC NH·∫¨N ƒê·∫∂T V√â
        </button>

    </div>

    <!-- Payment Method Modal -->
    <div id="paymentModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 9999; display: none; align-items: center; justify-content: center;">
        <div style="background: #141a3a; border: 2px solid #ff1f1f; border-radius: 12px; padding: 30px; max-width: 400px; text-align: center; box-shadow: 0 8px 32px rgba(255, 31, 31, 0.3);">
            <h2 style="color: #ff8c8c; margin-bottom: 20px; font-size: 20px;">Ch·ªçn Ph∆∞∆°ng Th·ª©c Thanh To√°n</h2>
            <p style="color: #cfd3ff; margin-bottom: 25px; font-size: 14px;">Vui l√≤ng ch·ªçn c√°ch thanh to√°n cho v√© c·ªßa b·∫°n</p>
            
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <button id="depositBtn" 
                    style="padding: 15px; background: #1b2150; border: 2px solid #00b7ff; border-radius: 8px; color: #00b7ff; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s ease;">
                    üí∞ C·ªçc 50% Ti·ªÅn V√©
                </button>
                
                <button id="bankBtn" 
                    style="padding: 15px; background: #1b2150; border: 2px solid #00b7ff; border-radius: 8px; color: #00b7ff; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s ease;">
                    üè¶ Tr·∫£ B·∫±ng Ng√¢n H√†ng
                </button>
            </div>
            
            <button id="cancelPaymentBtn" 
                style="margin-top: 20px; padding: 10px 20px; background: transparent; border: 1px solid #666; border-radius: 6px; color: #999; font-size: 14px; cursor: pointer; transition: all 0.3s ease;">
                H·ªßy
            </button>
        </div>
    </div>
</body>
</html>

<script src="../js/api-client.js"></script>
<script src="../js/storage.js"></script>
<script src="../js/notification.js"></script>
<script>
    let selectedSeats = [];
    let movieId = null;
    let showingId = null; // Initialize to null, will be set by getOrCreateShowing
    let currentMovie = null;
    let requiredQuantity = 0;
    let allSeats = []; // Store all seats with their info
    let selectedPaymentMethod = null; // Store selected payment method

    function debug(msg) {
        console.log(msg);
        // Uncomment to show debug panel
        // document.getElementById('debugPanel').style.display = 'block';
        // document.getElementById('debugText').textContent = msg;
    }

    window.addEventListener('DOMContentLoaded', () => {
        loadMovieInfo();
    });

    async function loadMovieInfo() {
        const params = new URLSearchParams(window.location.search);
        movieId = params.get('id');

        console.log('>>> URL params:', window.location.search);
        console.log('>>> Extracted movieId:', movieId);

        // IMPORTANT: Reset showingId when loading new movie
        showingId = null;
        console.log('>>> Reset showingId to null');

        if (!movieId) {
            Notification.error('Kh√¥ng t√¨m th·∫•y phim');
            setTimeout(() => window.location.href = 'index.html', 1500);
            return;
        }

        // Get booking info from session storage
        const bookingInfo = JSON.parse(sessionStorage.getItem('bookingInfo') || '{}');
        requiredQuantity = parseInt(bookingInfo.quantity) || 0;

        if (requiredQuantity === 0) {
            Notification.error('Kh√¥ng t√¨m th·∫•y th√¥ng tin s·ªë l∆∞·ª£ng v√©');
            setTimeout(() => window.location.href = 'index.html', 1500);
            return;
        }

        try {
            // Load movie with showings from database
            const response = await APIClient.getMovieWithShowings(movieId);
            if (response && response.success) {
                currentMovie = response.data.movie;
                document.getElementById('movieName').textContent = currentMovie.title || 'Kh√¥ng x√°c ƒë·ªãnh';
                document.getElementById('ticketQuantity').textContent = `B·∫°n c·∫ßn ch·ªçn ${requiredQuantity} gh·∫ø`;
                document.getElementById('maxCount').textContent = requiredQuantity;
                
                // Display movie information from database
                displayMovieInfo(currentMovie);
                
                // Get first showing for this movie with details
                await getFirstAvailableShowingWithDetails();
                
                // Load seats from database
                await loadSeatsFromDatabase();
                setupSeatSelection();
                setupButtons();
            } else {
                Notification.error('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin phim');
                setTimeout(() => window.location.href = 'index.html', 1500);
            }
        } catch (error) {
            console.error('Error loading movie:', error);
            Notification.error('L·ªói khi t·∫£i th√¥ng tin phim');
            setTimeout(() => window.location.href = 'index.html', 1500);
        }
    }

    function displayMovieInfo(movie) {
        // Display movie details in the info section
        const infoSection = document.getElementById('movieInfoSection');
        if (movie) {
            document.getElementById('movieGenre').textContent = movie.genre || 'N/A';
            document.getElementById('movieDirector').textContent = movie.director || 'N/A';
            document.getElementById('movieDuration').textContent = movie.duration || 'N/A';
            document.getElementById('movieRating').textContent = movie.rating || 'N/A';
            infoSection.style.display = 'block';
        }
    }

    async function getFirstAvailableShowingWithDetails() {
        try {
            // Check if showing_id is already selected (from choose-showing.html)
            const bookingInfo = JSON.parse(sessionStorage.getItem('bookingInfo') || '{}');
            
            if (bookingInfo.showing_id) {
                // Use pre-selected showing_id from choose-showing.html
                showingId = parseInt(bookingInfo.showing_id);
                console.log('>>> Using pre-selected showingId from choose-showing.html:', showingId);
            } else {
                // Fallback: Try to get or create showing (old behavior)
                let getOrCreateRes = null;
                let retryCount = 0;
                const maxRetries = 2;

                while (!getOrCreateRes || !getOrCreateRes.success) {
                    console.log(`>>> Calling getOrCreateShowing for movieId: ${movieId} (attempt ${retryCount + 1})`);
                    getOrCreateRes = await APIClient.getOrCreateShowing(movieId);
                    console.log('>>> getOrCreateShowing response:', getOrCreateRes);
                    
                    retryCount++;
                    if (!getOrCreateRes || !getOrCreateRes.success) {
                        if (retryCount >= maxRetries) {
                            console.warn('getOrCreateShowing failed after retries, using fallback showing_id=1');
                            showingId = 1;
                            document.getElementById('showingInfo').textContent = 'H√¥m nay';
                            document.getElementById('ticketPrice').textContent = 'N/A';
                            return;
                        }
                        // Wait a bit before retrying
                        await new Promise(r => setTimeout(r, 500));
                        continue;
                    }
                    break; // Success, exit loop
                }
                
                // Use the showing_id from get_or_create
                if (!getOrCreateRes.data || !getOrCreateRes.data.showing_id) {
                    console.error('Response missing showing_id!', getOrCreateRes);
                    showingId = 1;
                    return;
                }
                
                showingId = parseInt(getOrCreateRes.data.showing_id);
                console.log('>>> Setting showingId to:', showingId, 'type:', typeof showingId);
                
                if (!showingId || isNaN(showingId)) {
                    console.error('showingId is invalid after parsing:', getOrCreateRes.data.showing_id);
                    showingId = 1;
                    return;
                }
            }
            
            // Get showings for this movie to get time info
            const response = await APIClient.getShowings(movieId);
            
            if (!response || !response.success) {
                console.warn('Could not load showings details, using default time');
                document.getElementById('showingInfo').textContent = 'H√¥m nay';
                document.getElementById('ticketPrice').textContent = 'N/A';
                return;
            }
            
            const showings = response.data.showings || [];
            
            if (showings.length > 0) {
                // Find the showing we selected
                const currentShowing = showings.find(s => s.id == showingId) || showings[0];
                
                // Format and display showing info
                const showingDate = currentShowing.showing_date || '';
                const showingTime = currentShowing.showing_time || '';
                
                // Format date from YYYY-MM-DD to DD/MM/YYYY
                let formattedDate = showingDate;
                if (showingDate) {
                    const dateParts = showingDate.split('-');
                    if (dateParts.length === 3) {
                        formattedDate = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
                    }
                }
                
                // Format time from HH:MM:SS to HH:MM
                let formattedTime = showingTime;
                if (showingTime) {
                    formattedTime = showingTime.substring(0, 5);
                }
                
                document.getElementById('showingInfo').textContent = `${formattedDate} l√∫c ${formattedTime}`;
                
                // Display room number
                const roomNum = currentShowing.room_number || 'N/A';
                document.getElementById('roomNumber').textContent = `Ph√≤ng ${roomNum}`;
                
                // Get price from the movie object
                if (currentMovie && currentMovie.price) {
                    const price = parseFloat(currentMovie.price);
                    document.getElementById('ticketPrice').textContent = `${formatCurrency(price)}/v√©`;
                    console.log('Using movie price from database:', price);
                } else {
                    document.getElementById('ticketPrice').textContent = 'N/A';
                    console.warn('Movie price not available');
                }
            } else {
                console.warn('No showings found');
                document.getElementById('showingInfo').textContent = 'H√¥m nay';
                document.getElementById('ticketPrice').textContent = 'N/A';
            }
        } catch (error) {
            console.error('Error getting showing:', error);
            console.warn('Using fallback showing_id=1');
            showingId = 1;
        }
    }

    function formatCurrency(amount) {
        return new Intl.NumberFormat('vi-VN', { 
            style: 'currency', 
            currency: 'VND',
            minimumFractionDigits: 0 
        }).format(amount);
    }

    async function loadSeatsFromDatabase() {
        try {
            // Get seats from database
            console.log('Loading seats for showing_id:', showingId, 'movieId:', movieId);
            const response = await APIClient.getSeats(showingId);
            
            console.log('Seats response:', response);
            
            if (!response.success) {
                console.error('Failed to load seats:', response.message);
                Notification.error('L·ªói khi t·∫£i danh s√°ch gh·∫ø: ' + response.message);
                return;
            }

            allSeats = response.data.seats || [];
            console.log('Total seats loaded:', allSeats.length);
            
            if (allSeats.length === 0) {
                console.warn('No seats found! Creating fallback seats for movieId:', movieId);
                createFallbackSeats();
                // Wait for fallback seats to be marked
                await loadBookedSeatsForFallback();
                return;
            }
            
            // Render seats dynamically
            renderSeats();
        } catch (error) {
            console.error('Error loading seats:', error);
            Notification.error('L·ªói khi t·∫£i danh s√°ch gh·∫ø');
        }
    }

    function createFallbackSeats() {
        // Create fallback seats if database is empty
        // Each movie gets its own set of fallback seats stored in sessionStorage
        const fallbackKey = `fallback_seats_movie_${movieId}_showing_${showingId}`;
        
        // Check if we already created fallback for this movie+showing
        const cached = sessionStorage.getItem(fallbackKey);
        if (cached) {
            console.log('Using cached fallback seats for movieId:', movieId, 'showing:', showingId);
            allSeats = JSON.parse(cached);
            return;
        }
        
        console.log('Creating new fallback seats for movieId:', movieId, 'showing:', showingId);
        allSeats = [];
        let seatId = 1;
        
        // Create 6 rows x 8 seats = 48 seats
        for (let row = 0; row < 6; row++) {
            for (let col = 0; col < 8; col++) {
                const rowLetter = String.fromCharCode(65 + row); // A, B, C, D, E, F
                const colNumber = col + 1;
                
                allSeats.push({
                    id: seatId,
                    seat_number: rowLetter + colNumber,
                    is_booked: false,
                    showing_id: showingId,
                    movie_id: movieId
                });
                seatId++;
            }
        }
        
        // Cache fallback seats in sessionStorage
        sessionStorage.setItem(fallbackKey, JSON.stringify(allSeats));
    }

    async function loadBookedSeatsForFallback() {
        // Fetch all bookings for this movie to mark booked seats in fallback mode
        try {
            const bookingsRes = await APIClient.getBookings();
            if (bookingsRes.success) {
                const allBookings = bookingsRes.data.bookings || [];
                
                // Filter: Only count confirmed/pending bookings for current showing
                // Do NOT filter by movieId because we're in fallback mode - different movie has different showingId
                const showingBookings = allBookings.filter(b => {
                    return b.showing_id == showingId && (b.status === 'pending' || b.status === 'confirmed');
                });
                
                // Get all booked seat numbers for this showing
                const bookedSeatNumbers = new Set();
                showingBookings.forEach(booking => {
                    if (booking.seat_numbers && Array.isArray(booking.seat_numbers)) {
                        booking.seat_numbers.forEach(seatNum => {
                            bookedSeatNumbers.add(String(seatNum).trim());
                        });
                    }
                });
                
                console.log(`Showing ${showingId}: Found ${showingBookings.length} bookings, ${bookedSeatNumbers.size} booked seats:`, Array.from(bookedSeatNumbers));
                
                // Mark booked seats in fallback
                allSeats.forEach(seat => {
                    if (bookedSeatNumbers.has(String(seat.seat_number).trim())) {
                        seat.is_booked = true;
                    }
                });
                
                console.log('Marked booked seats for fallback:', Array.from(bookedSeatNumbers));
                // Update cache
                sessionStorage.setItem(`fallback_seats_movie_${movieId}_showing_${showingId}`, JSON.stringify(allSeats));
            }
        } catch (error) {
            console.error('Error loading booked seats for fallback:', error);
        }
        
        renderSeats();
    }

    function renderSeats() {
        console.log('Rendering seats...');
        const container = document.getElementById('seatsContainer');
        
        if (!container) {
            console.error('seatsContainer not found!');
            return;
        }
        
        container.innerHTML = '';

        if (!allSeats || allSeats.length === 0) {
            console.error('No seats to render!');
            container.innerHTML = '<p style="color: white; text-align: center;">Kh√¥ng c√≥ gh·∫ø ƒë·ªÉ hi·ªÉn th·ªã</p>';
            return;
        }

        // Group seats by row (8 seats per row, 6 rows)
        const seatsPerRow = 8;
        const totalRows = Math.ceil(allSeats.length / seatsPerRow);
        
        console.log(`Rendering ${allSeats.length} seats in ${totalRows} rows`);

        for (let rowIndex = 0; rowIndex < totalRows; rowIndex++) {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'row';

            const startIdx = rowIndex * seatsPerRow;
            const endIdx = Math.min(startIdx + seatsPerRow, allSeats.length);

            for (let i = startIdx; i < endIdx; i++) {
                const seat = allSeats[i];
                const seatDiv = document.createElement('div');
                seatDiv.className = 'seat';
                seatDiv.dataset.id = seat.id;
                seatDiv.dataset.number = seat.seat_number;

                // Convert is_booked to boolean (handle string "0"/"1" from database)
                const isBooked = seat.is_booked === true || seat.is_booked === '1' || parseInt(seat.is_booked) === 1;

                if (isBooked) {
                    seatDiv.classList.add('occupied');
                }

                seatDiv.textContent = seat.seat_number;
                seatDiv.style.fontSize = '11px';
                seatDiv.style.display = 'flex';
                seatDiv.style.alignItems = 'center';
                seatDiv.style.justifyContent = 'center';
                seatDiv.style.cursor = isBooked ? 'not-allowed' : 'pointer';

                rowDiv.appendChild(seatDiv);
            }

            container.appendChild(rowDiv);
        }
        
        console.log('Seats rendered successfully');
    }

    function setupSeatSelection() {
        const seats = document.querySelectorAll('.row .seat:not(.occupied)');
        seats.forEach(seat => {
            seat.addEventListener('click', function() {
                // N·∫øu gh·∫ø ƒë√£ ƒë∆∞·ª£c ch·ªçn th√¨ b·ªè ch·ªçn
                if (this.classList.contains('selected')) {
                    this.classList.remove('selected');
                    updateSelectedSeats();
                    return;
                }

                // N·∫øu ƒë√£ ch·ªçn ƒë·ªß s·ªë l∆∞·ª£ng y√™u c·∫ßu th√¨ kh√¥ng cho ch·ªçn th√™m
                if (selectedSeats.length >= requiredQuantity) {
                    Notification.warning(`B·∫°n ch·ªâ c√≥ th·ªÉ ch·ªçn t·ªëi ƒëa ${requiredQuantity} gh·∫ø`);
                    return;
                }

                // Ch·ªçn gh·∫ø
                this.classList.add('selected');
                updateSelectedSeats();
            });
        });
    }

    function updateSelectedSeats() {
        selectedSeats = [];
        document.querySelectorAll('.row .seat.selected').forEach(seat => {
            selectedSeats.push({
                id: parseInt(seat.dataset.id),
                number: seat.dataset.number
            });
        });
        document.getElementById('count').textContent = selectedSeats.length;

        // Enable/disable confirm button based on selection
        const confirmBtn = document.getElementById('confirmBtn');
        if (selectedSeats.length === requiredQuantity) {
            confirmBtn.style.opacity = '1';
            confirmBtn.style.cursor = 'pointer';
            confirmBtn.disabled = false;
        } else {
            confirmBtn.style.opacity = '0.6';
            confirmBtn.style.cursor = 'not-allowed';
            confirmBtn.disabled = true;
        }
    }

    function setupButtons() {
        document.getElementById('confirmBtn').addEventListener('click', showPaymentModal);
        
        // Payment modal button handlers
        document.getElementById('depositBtn').addEventListener('click', () => {
            selectedPaymentMethod = 'deposit';
            proceedWithBooking();
        });
        
        document.getElementById('bankBtn').addEventListener('click', () => {
            selectedPaymentMethod = 'bank_transfer';
            proceedWithBooking();
        });
        
        document.getElementById('cancelPaymentBtn').addEventListener('click', hidePaymentModal);
        
        // Close modal when clicking outside of it
        document.getElementById('paymentModal').addEventListener('click', (e) => {
            if (e.target.id === 'paymentModal') {
                hidePaymentModal();
            }
        });
        
        // Disable confirm button initially
        document.getElementById('confirmBtn').disabled = true;
        document.getElementById('confirmBtn').style.opacity = '0.6';
        document.getElementById('confirmBtn').style.cursor = 'not-allowed';
    }

    function showPaymentModal() {
        const modal = document.getElementById('paymentModal');
        modal.style.display = 'flex';
        
        // Add hover effects
        const depositBtn = document.getElementById('depositBtn');
        const bankBtn = document.getElementById('bankBtn');
        
        depositBtn.addEventListener('mouseenter', function() {
            this.style.background = '#00b7ff';
            this.style.color = '#141a3a';
        });
        depositBtn.addEventListener('mouseleave', function() {
            this.style.background = '#1b2150';
            this.style.color = '#00b7ff';
        });
        
        bankBtn.addEventListener('mouseenter', function() {
            this.style.background = '#00b7ff';
            this.style.color = '#141a3a';
        });
        bankBtn.addEventListener('mouseleave', function() {
            this.style.background = '#1b2150';
            this.style.color = '#00b7ff';
        });
    }

    function hidePaymentModal() {
        const modal = document.getElementById('paymentModal');
        modal.style.display = 'none';
    }

    async function proceedWithBooking() {
        hidePaymentModal();
        await confirmBooking();
    }

    async function confirmBooking() {
        console.log('>>> CONFIRM BOOKING CLICKED');
        console.log('>>> Current showingId:', showingId, 'type:', typeof showingId);
        console.log('>>> Current movieId:', movieId, 'type:', typeof movieId);
        
        const user = Storage.getUser();
        console.log('>>> User object:', user);
        
        if (!user || (!user.id && !user.user_id)) {
            Notification.error('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë·∫∑t v√©');
            setTimeout(() => window.location.href = 'auth.html', 1500);
            return;
        }

        if (selectedSeats.length !== requiredQuantity) {
            Notification.error(`Vui l√≤ng ch·ªçn ƒë√∫ng ${requiredQuantity} gh·∫ø`);
            return;
        }

        if (!currentMovie) {
            Notification.error('Kh√¥ng t√¨m th·∫•y th√¥ng tin phim');
            return;
        }

        // Validate showing_id
        if (showingId === null || showingId === undefined || isNaN(showingId)) {
            console.error('showingId is invalid:', showingId);
            // Try to use showing_id 1 as fallback
            showingId = 1;
            console.log('Using fallback showing_id:', showingId);
        }

        // Validate seats
        if (!selectedSeats || selectedSeats.length === 0) {
            Notification.error('Vui l√≤ng ch·ªçn gh·∫ø');
            return;
        }

        // Create booking with actual seat IDs
        try {
            const seatIds = selectedSeats.map(s => parseInt(s.id)); // Ensure IDs are numbers
            
            // Use user.id first, then fall back to user.user_id
            const userId = user.id || user.user_id;
            
            const bookingData = {
                user_id: parseInt(userId),
                movie_id: parseInt(movieId),
                showing_id: parseInt(showingId),
                seats: seatIds, // Use actual seat IDs as numbers
                payment_method: selectedPaymentMethod || 'cash'
            };
            
            // Validate all fields before sending
            console.log('=== User Info ===');
            console.log('user object:', user);
            console.log('user.id:', user.id, typeof user.id);
            console.log('user.user_id:', user.user_id, typeof user.user_id);
            console.log('=== Booking Data ===');
            console.log('user_id:', bookingData.user_id, typeof bookingData.user_id);
            console.log('movie_id:', bookingData.movie_id, typeof bookingData.movie_id);
            console.log('showing_id:', bookingData.showing_id, typeof bookingData.showing_id);
            console.log('seats:', bookingData.seats, 'count:', bookingData.seats.length);
            console.log('payment_method:', bookingData.payment_method);
            
            // Check for invalid values
            if (!bookingData.user_id || bookingData.user_id === 0) {
                Notification.error('L·ªói: Kh√¥ng t√¨m th·∫•y th√¥ng tin ng∆∞·ªùi d√πng');
                return;
            }
            if (!bookingData.movie_id) {
                Notification.error('L·ªói: Kh√¥ng t√¨m th·∫•y th√¥ng tin phim');
                return;
            }
            if (!bookingData.showing_id) {
                Notification.error('L·ªói: Kh√¥ng t√¨m th·∫•y su·∫•t chi·∫øu (ID: ' + showingId + ')');
                return;
            }
            if (bookingData.seats.length === 0) {
                Notification.error('L·ªói: Vui l√≤ng ch·ªçn gh·∫ø');
                return;
            }
            
            console.log('>>> Calling BookingsClient.createBooking with:', bookingData);
            const response = await APIClient.createBooking(bookingData);
            console.log('>>> Booking response:', response);

            if (response.success) {
                Notification.success('ƒê·∫∑t v√© th√†nh c√¥ng! M√£ ƒë·∫∑t v√©: #' + response.data.booking_id);
                setTimeout(() => {
                    sessionStorage.removeItem('bookingInfo');
                    window.location.href = 'bookings-history.html';
                }, 1500);
            } else {
                console.error('Booking error response:', response);
                Notification.error(response.message || 'L·ªói khi ƒë·∫∑t v√©');
            }
        } catch (error) {
            console.error('Error creating booking:', error);
            Notification.error('L·ªói khi ƒë·∫∑t v√©: ' + error.message);
        }
    }
</script>