<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Choose Seat Movie</title>
    <link rel="stylesheet" href="css/choose-seat.css">
    <link rel="stylesheet" href="/css/notification.css">
</head>
<body>
    <div class="movie-container">
        <label>Bạn đang đặt vé cho phim:</label>
        <h2 id="movieName" style="color:white; margin-top:5px;"></h2>
        <p id="ticketQuantity" style="color:#00b7ff; margin-top:10px; font-size:16px;"></p>

        
        <ul class="showcase">
            <li>
                <div class="seat"></div>
                <small>Có sẵn</small>
            </li>
            <li>
                <div class="seat selected"></div>
                <small>Đã chọn</small>
            </li>
            <li>
                <div class="seat occupied"></div>
                <small>Đã có người đặt</small>
            </li>
        </ul>
    </div>
    <div class="container">
        <div class="screen"></div>
        <div id="seatsContainer">
            <p style="color: white; text-align: center;">Đang tải ghế...</p>
        </div>
        <div id="debugPanel" style="color: #0f0; font-size: 12px; margin-top: 20px; padding: 10px; background: rgba(0,0,0,0.5); border-radius: 5px; max-width: 600px; display: none;">
            <p>Debug: <span id="debugText">Loading...</span></p>
        </div>
    </div>
    <p class="text">
        Bạn đã chọn <span id="count">0</span> / <span id="maxCount">0</span> chỗ
    </p>
    <div class="action-buttons" style="margin-top: 20px; display: flex; gap: 20px; justify-content: center;">
    
        <button id="confirmBtn" 
            style="padding: 12px 25px; background:#00b7ff; border:none; border-radius:6px;
                font-size:16px; color:white; cursor:pointer; font-weight:bold;">
            XÁC NHẬN ĐẶT VÉ
        </button>

        <button id="clearBtn" 
            style="padding: 12px 25px; background:#ff4e4e; border:none; border-radius:6px;
                font-size:16px; color:white; cursor:pointer; font-weight:bold;">
            XÓA LỰA CHỌN
        </button>

    </div>
</body>
</html>

<script src="/js/api-client.js"></script>
<script src="/js/bookings-client.js"></script>
<script src="/js/storage.js"></script>
<script src="/js/notification.js"></script>
<script>
    let selectedSeats = [];
    let movieId = null;
    let showingId = null;
    let currentMovie = null;
    let requiredQuantity = 0;
    let allSeats = []; // Store all seats with their info

    function debug(msg) {
        console.log(msg);
        // Uncomment to show debug panel
        // document.getElementById('debugPanel').style.display = 'block';
        // document.getElementById('debugText').textContent = msg;
    }

    window.addEventListener('DOMContentLoaded', () => {
        loadMovieInfo();
    });

    async function loadMovieInfo() {
        const params = new URLSearchParams(window.location.search);
        movieId = params.get('id');

        if (!movieId) {
            Notification.error('Không tìm thấy phim');
            setTimeout(() => window.location.href = 'index.html', 1500);
            return;
        }

        // Get booking info from session storage
        const bookingInfo = JSON.parse(sessionStorage.getItem('bookingInfo') || '{}');
        requiredQuantity = parseInt(bookingInfo.quantity) || 0;

        if (requiredQuantity === 0) {
            Notification.error('Không tìm thấy thông tin số lượng vé');
            setTimeout(() => window.location.href = 'index.html', 1500);
            return;
        }

        try {
            const response = await APIClient.getMovieById(movieId);
            if (response && response.success) {
                currentMovie = response.data.movie;
                document.getElementById('movieName').textContent = currentMovie.title || 'Không xác định';
                document.getElementById('ticketQuantity').textContent = `Bạn cần chọn ${requiredQuantity} ghế`;
                document.getElementById('maxCount').textContent = requiredQuantity;
                
                // Get first showing for this movie
                await getFirstAvailableShowing();
                
                // Load seats from database
                await loadSeatsFromDatabase();
                setupSeatSelection();
                setupButtons();
            } else {
                Notification.error('Không thể tải thông tin phim');
                setTimeout(() => window.location.href = 'index.html', 1500);
            }
        } catch (error) {
            console.error('Error loading movie:', error);
            Notification.error('Lỗi khi tải thông tin phim');
            setTimeout(() => window.location.href = 'index.html', 1500);
        }
    }

    async function getFirstAvailableShowing() {
        try {
            // Try to get showings for this movie
            const response = await APIClient.getShowings();
            
            if (!response || !response.success) {
                console.warn('Could not load showings, using default showing_id=1');
                showingId = 1;
                return;
            }
            
            const showings = response.data.showings || [];
            
            if (showings.length > 0) {
                // Use first available showing
                showingId = showings[0].id;
                console.log('Using showing ID:', showingId);
            } else {
                console.warn('No showings found, using default showing_id=1');
                showingId = 1;
            }
        } catch (error) {
            console.error('Error getting showing:', error);
            showingId = 1;
        }
    }

    async function loadSeatsFromDatabase() {
        try {
            // Get seats from database
            console.log('Loading seats for showing_id:', showingId);
            const response = await APIClient.getSeats(showingId);
            
            console.log('Seats response:', response);
            
            if (!response.success) {
                console.error('Failed to load seats:', response.message);
                Notification.error('Lỗi khi tải danh sách ghế: ' + response.message);
                return;
            }

            allSeats = response.data.seats || [];
            console.log('Total seats loaded:', allSeats.length);
            
            if (allSeats.length === 0) {
                console.warn('No seats found! Creating fallback seats...');
                createFallbackSeats();
                return;
            }
            
            // Render seats dynamically
            renderSeats();
        } catch (error) {
            console.error('Error loading seats:', error);
            Notification.error('Lỗi khi tải danh sách ghế');
        }
    }

    function createFallbackSeats() {
        // Create fallback seats if database is empty
        console.log('Creating fallback seats for demo purposes...');
        allSeats = [];
        let seatId = 1;
        
        // Create 6 rows x 8 seats = 48 seats
        for (let row = 0; row < 6; row++) {
            for (let col = 0; col < 8; col++) {
                const rowLetter = String.fromCharCode(65 + row); // A, B, C, D, E, F
                const colNumber = col + 1;
                
                allSeats.push({
                    id: seatId,
                    seat_number: rowLetter + colNumber,
                    is_booked: false,
                    showing_id: showingId
                });
                seatId++;
            }
        }
        
        renderSeats();
    }

    function renderSeats() {
        console.log('Rendering seats...');
        const container = document.getElementById('seatsContainer');
        
        if (!container) {
            console.error('seatsContainer not found!');
            return;
        }
        
        container.innerHTML = '';

        if (!allSeats || allSeats.length === 0) {
            console.error('No seats to render!');
            container.innerHTML = '<p style="color: white; text-align: center;">Không có ghế để hiển thị</p>';
            return;
        }

        // Group seats by row (8 seats per row, 6 rows)
        const seatsPerRow = 8;
        const totalRows = Math.ceil(allSeats.length / seatsPerRow);
        
        console.log(`Rendering ${allSeats.length} seats in ${totalRows} rows`);

        for (let rowIndex = 0; rowIndex < totalRows; rowIndex++) {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'row';

            const startIdx = rowIndex * seatsPerRow;
            const endIdx = Math.min(startIdx + seatsPerRow, allSeats.length);

            for (let i = startIdx; i < endIdx; i++) {
                const seat = allSeats[i];
                const seatDiv = document.createElement('div');
                seatDiv.className = 'seat';
                seatDiv.dataset.id = seat.id;
                seatDiv.dataset.number = seat.seat_number;

                if (seat.is_booked) {
                    seatDiv.classList.add('occupied');
                }

                seatDiv.textContent = seat.seat_number;
                seatDiv.style.fontSize = '11px';
                seatDiv.style.display = 'flex';
                seatDiv.style.alignItems = 'center';
                seatDiv.style.justifyContent = 'center';
                seatDiv.style.cursor = seat.is_booked ? 'not-allowed' : 'pointer';

                rowDiv.appendChild(seatDiv);
            }

            container.appendChild(rowDiv);
        }
        
        console.log('Seats rendered successfully');
    }

    function setupSeatSelection() {
        const seats = document.querySelectorAll('.row .seat:not(.occupied)');
        seats.forEach(seat => {
            seat.addEventListener('click', function() {
                // Nếu ghế đã được chọn thì bỏ chọn
                if (this.classList.contains('selected')) {
                    this.classList.remove('selected');
                    updateSelectedSeats();
                    return;
                }

                // Nếu đã chọn đủ số lượng yêu cầu thì không cho chọn thêm
                if (selectedSeats.length >= requiredQuantity) {
                    Notification.warning(`Bạn chỉ có thể chọn tối đa ${requiredQuantity} ghế`);
                    return;
                }

                // Chọn ghế
                this.classList.add('selected');
                updateSelectedSeats();
            });
        });
    }

    function updateSelectedSeats() {
        selectedSeats = [];
        document.querySelectorAll('.row .seat.selected').forEach(seat => {
            selectedSeats.push({
                id: parseInt(seat.dataset.id),
                number: seat.dataset.number
            });
        });
        document.getElementById('count').textContent = selectedSeats.length;

        // Enable/disable confirm button based on selection
        const confirmBtn = document.getElementById('confirmBtn');
        if (selectedSeats.length === requiredQuantity) {
            confirmBtn.style.opacity = '1';
            confirmBtn.style.cursor = 'pointer';
            confirmBtn.disabled = false;
        } else {
            confirmBtn.style.opacity = '0.6';
            confirmBtn.style.cursor = 'not-allowed';
            confirmBtn.disabled = true;
        }
    }

    function setupButtons() {
        document.getElementById('confirmBtn').addEventListener('click', confirmBooking);
        document.getElementById('clearBtn').addEventListener('click', clearSelection);
        
        // Disable confirm button initially
        document.getElementById('confirmBtn').disabled = true;
        document.getElementById('confirmBtn').style.opacity = '0.6';
        document.getElementById('confirmBtn').style.cursor = 'not-allowed';
    }

    function clearSelection() {
        document.querySelectorAll('.seat.selected').forEach(seat => {
            seat.classList.remove('selected');
        });
        updateSelectedSeats();
    }

    async function confirmBooking() {
        const user = Storage.getUser();
        if (!user) {
            Notification.error('Vui lòng đăng nhập để đặt vé');
            setTimeout(() => window.location.href = 'login.html', 1500);
            return;
        }

        if (selectedSeats.length !== requiredQuantity) {
            Notification.error(`Vui lòng chọn đúng ${requiredQuantity} ghế`);
            return;
        }

        if (!currentMovie) {
            Notification.error('Không tìm thấy thông tin phim');
            return;
        }

        // Ensure showing_id is set
        if (!showingId) {
            Notification.error('Không tìm thấy thông tin suất chiếu');
            return;
        }

        // Create booking with actual seat IDs
        try {
            const bookingData = {
                user_id: parseInt(user.id),
                movie_id: parseInt(movieId),
                showing_id: parseInt(showingId),
                seats: selectedSeats.map(s => parseInt(s.id)),
                payment_method: 'cash'
            };

            console.log('Booking data:', bookingData);

            const response = await BookingsClient.createBooking(bookingData);

            console.log('Booking response:', response);

            if (response.success) {
                Notification.success('Đặt vé thành công! Mã đặt vé: #' + response.data.booking_id);
                setTimeout(() => {
                    sessionStorage.removeItem('bookingInfo');
                    window.location.href = 'bookings-history.html';
                }, 1500);
            } else {
                Notification.error(response.message || 'Lỗi khi đặt vé');
            }
        } catch (error) {
            console.error('Error creating booking:', error);
            Notification.error('Lỗi khi đặt vé: ' + error.message);
        }
    }
</script>