<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Choose Seat Movie</title>
    <link rel="stylesheet" href="css/choose-seat.css">
    <link rel="stylesheet" href="/css/notification.css">
</head>
<body>
    <div class="movie-container">
        <label>Bạn đang đặt vé cho phim:</label>
        <h2 id="movieName" style="color:white; margin-top:5px;"></h2>
        
        <!-- Movie Information Section -->
        <div id="movieInfoSection" style="color:#00b7ff; margin-top:15px; font-size:14px; padding: 15px; background: rgba(0, 183, 255, 0.1); border-radius: 5px; display: none;">
            <div><strong>Thể loại:</strong> <span id="movieGenre"></span></div>
            <div><strong>Đạo diễn:</strong> <span id="movieDirector"></span></div>
            <div><strong>Thời lượng:</strong> <span id="movieDuration"></span> phút</div>
            <div><strong>Đánh giá:</strong> <span id="movieRating"></span>/5</div>
            <div style="margin-top: 10px; border-top: 1px solid #00b7ff; padding-top: 10px;">
                <div><strong>Suất chiếu:</strong> <span id="showingInfo"></span></div>
                <div><strong>Giá vé:</strong> <span id="ticketPrice" style="color: #ffff00; font-weight: bold;"></span></div>
            </div>
        </div>
        
        <p id="ticketQuantity" style="color:#00b7ff; margin-top:10px; font-size:16px;"></p>

        
        <ul class="showcase">
            <li>
                <div class="seat"></div>
                <small>Có sẵn</small>
            </li>
            <li>
                <div class="seat selected"></div>
                <small>Đã chọn</small>
            </li>
            <li>
                <div class="seat occupied"></div>
                <small>Đã có người đặt</small>
            </li>
        </ul>
    </div>
    <div class="container">
        <div class="screen"></div>
        <div id="seatsContainer">
            <p style="color: white; text-align: center;">Đang tải ghế...</p>
        </div>
        <div id="debugPanel" style="color: #0f0; font-size: 12px; margin-top: 20px; padding: 10px; background: rgba(0,0,0,0.5); border-radius: 5px; max-width: 600px; display: none;">
            <p>Debug: <span id="debugText">Loading...</span></p>
        </div>
    </div>
    <p class="text">
        Bạn đã chọn <span id="count">0</span> / <span id="maxCount">0</span> chỗ
    </p>
    <div class="action-buttons" style="margin-top: 20px; display: flex; gap: 20px; justify-content: center;">
    
        <button id="confirmBtn" 
            style="padding: 12px 25px; background:#00b7ff; border:none; border-radius:6px;
                font-size:16px; color:white; cursor:pointer; font-weight:bold;">
            XÁC NHẬN ĐẶT VÉ
        </button>

    </div>
</body>
</html>

<script src="/js/api-client.js"></script>
<script src="/js/bookings-client.js"></script>
<script src="/js/storage.js"></script>
<script src="/js/notification.js"></script>
<script>
    let selectedSeats = [];
    let movieId = null;
    let showingId = null; // Initialize to null, will be set by getOrCreateShowing
    let currentMovie = null;
    let requiredQuantity = 0;
    let allSeats = []; // Store all seats with their info

    function debug(msg) {
        console.log(msg);
        // Uncomment to show debug panel
        // document.getElementById('debugPanel').style.display = 'block';
        // document.getElementById('debugText').textContent = msg;
    }

    window.addEventListener('DOMContentLoaded', () => {
        loadMovieInfo();
    });

    async function loadMovieInfo() {
        const params = new URLSearchParams(window.location.search);
        movieId = params.get('id');

        console.log('>>> URL params:', window.location.search);
        console.log('>>> Extracted movieId:', movieId);

        // IMPORTANT: Reset showingId when loading new movie
        showingId = null;
        console.log('>>> Reset showingId to null');

        if (!movieId) {
            Notification.error('Không tìm thấy phim');
            setTimeout(() => window.location.href = 'index.html', 1500);
            return;
        }

        // Get booking info from session storage
        const bookingInfo = JSON.parse(sessionStorage.getItem('bookingInfo') || '{}');
        requiredQuantity = parseInt(bookingInfo.quantity) || 0;

        if (requiredQuantity === 0) {
            Notification.error('Không tìm thấy thông tin số lượng vé');
            setTimeout(() => window.location.href = 'index.html', 1500);
            return;
        }

        try {
            // Load movie with showings from database
            const response = await APIClient.getMovieWithShowings(movieId);
            if (response && response.success) {
                currentMovie = response.data.movie;
                document.getElementById('movieName').textContent = currentMovie.title || 'Không xác định';
                document.getElementById('ticketQuantity').textContent = `Bạn cần chọn ${requiredQuantity} ghế`;
                document.getElementById('maxCount').textContent = requiredQuantity;
                
                // Display movie information from database
                displayMovieInfo(currentMovie);
                
                // Get first showing for this movie with details
                await getFirstAvailableShowingWithDetails();
                
                // Load seats from database
                await loadSeatsFromDatabase();
                setupSeatSelection();
                setupButtons();
            } else {
                Notification.error('Không thể tải thông tin phim');
                setTimeout(() => window.location.href = 'index.html', 1500);
            }
        } catch (error) {
            console.error('Error loading movie:', error);
            Notification.error('Lỗi khi tải thông tin phim');
            setTimeout(() => window.location.href = 'index.html', 1500);
        }
    }

    function displayMovieInfo(movie) {
        // Display movie details in the info section
        const infoSection = document.getElementById('movieInfoSection');
        if (movie) {
            document.getElementById('movieGenre').textContent = movie.genre || 'N/A';
            document.getElementById('movieDirector').textContent = movie.director || 'N/A';
            document.getElementById('movieDuration').textContent = movie.duration || 'N/A';
            document.getElementById('movieRating').textContent = movie.rating || 'N/A';
            infoSection.style.display = 'block';
        }
    }

    async function getFirstAvailableShowingWithDetails() {
        try {
            // First, ensure showing exists for this movie
            console.log('>>> Calling getOrCreateShowing for movieId:', movieId);
            const getOrCreateRes = await APIClient.getOrCreateShowing(movieId);
            console.log('>>> getOrCreateShowing response:', getOrCreateRes);
            
            if (!getOrCreateRes || !getOrCreateRes.success) {
                console.warn('Could not get or create showing, keeping default showing_id=1');
                console.warn('Response was:', getOrCreateRes);
                document.getElementById('showingInfo').textContent = 'Mặc định';
                document.getElementById('ticketPrice').textContent = 'N/A';
                return;
            }
            
            // Use the showing_id from get_or_create
            if (!getOrCreateRes.data || !getOrCreateRes.data.showing_id) {
                console.error('Response missing showing_id!', getOrCreateRes);
                return;
            }
            
            showingId = parseInt(getOrCreateRes.data.showing_id);
            console.log('>>> Setting showingId to:', showingId, 'type:', typeof showingId);
            
            if (!showingId || isNaN(showingId)) {
                console.error('showingId is invalid after parsing:', getOrCreateRes.data.showing_id);
                return;
            }
            
            // Get showings for this movie to get time info
            const response = await APIClient.getShowings(movieId);
            
            if (!response || !response.success) {
                console.warn('Could not load showings details, using default time');
                document.getElementById('showingInfo').textContent = 'Hôm nay';
                document.getElementById('ticketPrice').textContent = 'N/A';
                return;
            }
            
            const showings = response.data.showings || [];
            
            if (showings.length > 0) {
                // Find the showing we just created/retrieved
                const currentShowing = showings.find(s => s.id == showingId) || showings[0];
                
                // Format and display showing info
                const showingDate = currentShowing.showing_date || '';
                const showingTime = currentShowing.showing_time || '';
                
                // Format date from YYYY-MM-DD to DD/MM/YYYY
                let formattedDate = showingDate;
                if (showingDate) {
                    const dateParts = showingDate.split('-');
                    if (dateParts.length === 3) {
                        formattedDate = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
                    }
                }
                
                // Format time from HH:MM:SS to HH:MM
                let formattedTime = showingTime;
                if (showingTime) {
                    formattedTime = showingTime.substring(0, 5);
                }
                
                document.getElementById('showingInfo').textContent = `${formattedDate} lúc ${formattedTime}`;
                
                // Get price from the movie object
                if (currentMovie && currentMovie.price) {
                    const price = parseFloat(currentMovie.price);
                    document.getElementById('ticketPrice').textContent = `${formatCurrency(price)}/vé`;
                    console.log('Using movie price from database:', price);
                } else {
                    document.getElementById('ticketPrice').textContent = 'N/A';
                    console.warn('Movie price not available');
                }
            } else {
                console.warn('No showings found');
                document.getElementById('showingInfo').textContent = 'Hôm nay';
                document.getElementById('ticketPrice').textContent = 'N/A';
            }
        } catch (error) {
            console.error('Error getting showing:', error);
            console.warn('Keeping default showing_id=1');
        }
    }

    function formatCurrency(amount) {
        return new Intl.NumberFormat('vi-VN', { 
            style: 'currency', 
            currency: 'VND',
            minimumFractionDigits: 0 
        }).format(amount);
    }

    async function loadSeatsFromDatabase() {
        try {
            // Get seats from database
            console.log('Loading seats for showing_id:', showingId, 'movieId:', movieId);
            const response = await APIClient.getSeats(showingId);
            
            console.log('Seats response:', response);
            
            if (!response.success) {
                console.error('Failed to load seats:', response.message);
                Notification.error('Lỗi khi tải danh sách ghế: ' + response.message);
                return;
            }

            allSeats = response.data.seats || [];
            console.log('Total seats loaded:', allSeats.length);
            
            if (allSeats.length === 0) {
                console.warn('No seats found! Creating fallback seats for movieId:', movieId);
                createFallbackSeats();
                // Wait for fallback seats to be marked
                await loadBookedSeatsForFallback();
                return;
            }
            
            // Render seats dynamically
            renderSeats();
        } catch (error) {
            console.error('Error loading seats:', error);
            Notification.error('Lỗi khi tải danh sách ghế');
        }
    }

    function createFallbackSeats() {
        // Create fallback seats if database is empty
        // Each movie gets its own set of fallback seats stored in sessionStorage
        const fallbackKey = `fallback_seats_movie_${movieId}_showing_${showingId}`;
        
        // Check if we already created fallback for this movie+showing
        const cached = sessionStorage.getItem(fallbackKey);
        if (cached) {
            console.log('Using cached fallback seats for movieId:', movieId, 'showing:', showingId);
            allSeats = JSON.parse(cached);
            return;
        }
        
        console.log('Creating new fallback seats for movieId:', movieId, 'showing:', showingId);
        allSeats = [];
        let seatId = 1;
        
        // Create 6 rows x 8 seats = 48 seats
        for (let row = 0; row < 6; row++) {
            for (let col = 0; col < 8; col++) {
                const rowLetter = String.fromCharCode(65 + row); // A, B, C, D, E, F
                const colNumber = col + 1;
                
                allSeats.push({
                    id: seatId,
                    seat_number: rowLetter + colNumber,
                    is_booked: false,
                    showing_id: showingId,
                    movie_id: movieId
                });
                seatId++;
            }
        }
        
        // Cache fallback seats in sessionStorage
        sessionStorage.setItem(fallbackKey, JSON.stringify(allSeats));
    }

    async function loadBookedSeatsForFallback() {
        // Fetch all bookings for this movie to mark booked seats in fallback mode
        try {
            const bookingsRes = await APIClient.getBookings();
            if (bookingsRes.success) {
                const allBookings = bookingsRes.data.bookings || [];
                
                // Filter: Only count confirmed/pending bookings for current showing
                // Do NOT filter by movieId because we're in fallback mode - different movie has different showingId
                const showingBookings = allBookings.filter(b => {
                    return b.showing_id == showingId && (b.status === 'pending' || b.status === 'confirmed');
                });
                
                // Get all booked seat numbers for this showing
                const bookedSeatNumbers = new Set();
                showingBookings.forEach(booking => {
                    if (booking.seat_numbers && Array.isArray(booking.seat_numbers)) {
                        booking.seat_numbers.forEach(seatNum => {
                            bookedSeatNumbers.add(String(seatNum).trim());
                        });
                    }
                });
                
                console.log(`Showing ${showingId}: Found ${showingBookings.length} bookings, ${bookedSeatNumbers.size} booked seats:`, Array.from(bookedSeatNumbers));
                
                // Mark booked seats in fallback
                allSeats.forEach(seat => {
                    if (bookedSeatNumbers.has(String(seat.seat_number).trim())) {
                        seat.is_booked = true;
                    }
                });
                
                console.log('Marked booked seats for fallback:', Array.from(bookedSeatNumbers));
                // Update cache
                sessionStorage.setItem(`fallback_seats_movie_${movieId}_showing_${showingId}`, JSON.stringify(allSeats));
            }
        } catch (error) {
            console.error('Error loading booked seats for fallback:', error);
        }
        
        renderSeats();
    }

    function renderSeats() {
        console.log('Rendering seats...');
        const container = document.getElementById('seatsContainer');
        
        if (!container) {
            console.error('seatsContainer not found!');
            return;
        }
        
        container.innerHTML = '';

        if (!allSeats || allSeats.length === 0) {
            console.error('No seats to render!');
            container.innerHTML = '<p style="color: white; text-align: center;">Không có ghế để hiển thị</p>';
            return;
        }

        // Group seats by row (8 seats per row, 6 rows)
        const seatsPerRow = 8;
        const totalRows = Math.ceil(allSeats.length / seatsPerRow);
        
        console.log(`Rendering ${allSeats.length} seats in ${totalRows} rows`);

        for (let rowIndex = 0; rowIndex < totalRows; rowIndex++) {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'row';

            const startIdx = rowIndex * seatsPerRow;
            const endIdx = Math.min(startIdx + seatsPerRow, allSeats.length);

            for (let i = startIdx; i < endIdx; i++) {
                const seat = allSeats[i];
                const seatDiv = document.createElement('div');
                seatDiv.className = 'seat';
                seatDiv.dataset.id = seat.id;
                seatDiv.dataset.number = seat.seat_number;

                // Convert is_booked to boolean (handle string "0"/"1" from database)
                const isBooked = seat.is_booked === true || seat.is_booked === '1' || parseInt(seat.is_booked) === 1;

                if (isBooked) {
                    seatDiv.classList.add('occupied');
                }

                seatDiv.textContent = seat.seat_number;
                seatDiv.style.fontSize = '11px';
                seatDiv.style.display = 'flex';
                seatDiv.style.alignItems = 'center';
                seatDiv.style.justifyContent = 'center';
                seatDiv.style.cursor = isBooked ? 'not-allowed' : 'pointer';

                rowDiv.appendChild(seatDiv);
            }

            container.appendChild(rowDiv);
        }
        
        console.log('Seats rendered successfully');
    }

    function setupSeatSelection() {
        const seats = document.querySelectorAll('.row .seat:not(.occupied)');
        seats.forEach(seat => {
            seat.addEventListener('click', function() {
                // Nếu ghế đã được chọn thì bỏ chọn
                if (this.classList.contains('selected')) {
                    this.classList.remove('selected');
                    updateSelectedSeats();
                    return;
                }

                // Nếu đã chọn đủ số lượng yêu cầu thì không cho chọn thêm
                if (selectedSeats.length >= requiredQuantity) {
                    Notification.warning(`Bạn chỉ có thể chọn tối đa ${requiredQuantity} ghế`);
                    return;
                }

                // Chọn ghế
                this.classList.add('selected');
                updateSelectedSeats();
            });
        });
    }

    function updateSelectedSeats() {
        selectedSeats = [];
        document.querySelectorAll('.row .seat.selected').forEach(seat => {
            selectedSeats.push({
                id: parseInt(seat.dataset.id),
                number: seat.dataset.number
            });
        });
        document.getElementById('count').textContent = selectedSeats.length;

        // Enable/disable confirm button based on selection
        const confirmBtn = document.getElementById('confirmBtn');
        if (selectedSeats.length === requiredQuantity) {
            confirmBtn.style.opacity = '1';
            confirmBtn.style.cursor = 'pointer';
            confirmBtn.disabled = false;
        } else {
            confirmBtn.style.opacity = '0.6';
            confirmBtn.style.cursor = 'not-allowed';
            confirmBtn.disabled = true;
        }
    }

    function setupButtons() {
        document.getElementById('confirmBtn').addEventListener('click', confirmBooking);
        
        // Disable confirm button initially
        document.getElementById('confirmBtn').disabled = true;
        document.getElementById('confirmBtn').style.opacity = '0.6';
        document.getElementById('confirmBtn').style.cursor = 'not-allowed';
    }

    async function confirmBooking() {
        console.log('>>> CONFIRM BOOKING CLICKED');
        console.log('>>> Current showingId:', showingId, 'type:', typeof showingId);
        console.log('>>> Current movieId:', movieId, 'type:', typeof movieId);
        
        const user = Storage.getUser();
        if (!user || !user.id) {
            Notification.error('Vui lòng đăng nhập để đặt vé');
            setTimeout(() => window.location.href = 'login.html', 1500);
            return;
        }

        if (selectedSeats.length !== requiredQuantity) {
            Notification.error(`Vui lòng chọn đúng ${requiredQuantity} ghế`);
            return;
        }

        if (!currentMovie) {
            Notification.error('Không tìm thấy thông tin phim');
            return;
        }

        // Validate showing_id
        if (showingId === null || showingId === undefined || showingId === 0 || isNaN(showingId)) {
            console.error('showingId is invalid:', showingId);
            Notification.error('Không tìm thấy suất chiếu. Vui lòng tải lại trang');
            return;
        }

        // Validate seats
        if (!selectedSeats || selectedSeats.length === 0) {
            Notification.error('Vui lòng chọn ghế');
            return;
        }

        // Create booking with actual seat IDs
        try {
            const seatIds = selectedSeats.map(s => parseInt(s.id)); // Ensure IDs are numbers
            
            const bookingData = {
                user_id: parseInt(user.user_id || user.id),
                movie_id: parseInt(movieId),
                showing_id: parseInt(showingId),
                seats: seatIds, // Use actual seat IDs as numbers
                payment_method: 'cash'
            };
            
            // Validate all fields before sending
            console.log('=== User Info ===');
            console.log('user object:', user);
            console.log('user.user_id:', user.user_id, typeof user.user_id);
            console.log('user.id:', user.id, typeof user.id);
            console.log('=== Booking Data ===');
            console.log('user_id:', bookingData.user_id, typeof bookingData.user_id);
            console.log('movie_id:', bookingData.movie_id, typeof bookingData.movie_id);
            console.log('showing_id:', bookingData.showing_id, typeof bookingData.showing_id);
            console.log('seats:', bookingData.seats, 'count:', bookingData.seats.length);
            console.log('payment_method:', bookingData.payment_method);
            
            // Check for invalid values
            if (!bookingData.user_id) {
                Notification.error('Lỗi: Không tìm thấy thông tin người dùng');
                return;
            }
            if (!bookingData.movie_id) {
                Notification.error('Lỗi: Không tìm thấy thông tin phim');
                return;
            }
            if (!bookingData.showing_id) {
                Notification.error('Lỗi: Không tìm thấy suất chiếu (ID: ' + showingId + ')');
                return;
            }
            if (bookingData.seats.length === 0) {
                Notification.error('Lỗi: Vui lòng chọn ghế');
                return;
            }
            
            const response = await BookingsClient.createBooking(bookingData);

            if (response.success) {
                Notification.success('Đặt vé thành công! Mã đặt vé: #' + response.data.booking_id);
                setTimeout(() => {
                    sessionStorage.removeItem('bookingInfo');
                    window.location.href = 'bookings-history.html';
                }, 1500);
            } else {
                console.error('Booking error response:', response);
                Notification.error(response.message || 'Lỗi khi đặt vé');
            }
        } catch (error) {
            console.error('Error creating booking:', error);
            Notification.error('Lỗi khi đặt vé: ' + error.message);
        }
    }
</script>