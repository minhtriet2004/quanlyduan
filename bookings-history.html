<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L·ªãch s·ª≠ ƒë·∫∑t v√© - RAP PHIM</title>
    <link rel="stylesheet" href="css/bookings-history.css">
    <link rel="stylesheet" href="css/notification.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo" onclick="window.location.href = 'index.html'" style="cursor: pointer;">RAP PHIM</div>
                <nav class="nav">
                    <a href="index.html" class="nav-link">Trang ch·ªß</a>
                </nav>
                <div class="header-actions">
                    <button class="btn-login" id="auth-btn" onclick="handleAuthClick()" style="display: none;">ƒêƒÉng nh·∫≠p</button>
                    <div class="user-section" id="user-profile" style="display: none;">
                        <div class="user-profile-wrapper" onclick="toggleUserDropdown()">
                            <div class="user-avatar">üë§</div>
                            <div class="user-info">
                                <span class="username" id="username-display">User</span>
                                <span class="user-email" id="user-email-display">email@cinema.vn</span>
                            </div>
                        </div>
                        <div class="user-dropdown" id="user-dropdown">
                            <a href="bookings-history.html" class="dropdown-item"><span class="icon">üé´</span> L·ªãch s·ª≠ ƒë·∫∑t v√©</a>
                            <a href="#" class="dropdown-item" onclick="handleLogout(event); return false;"><span class="icon">üö™</span> ƒêƒÉng xu·∫•t</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <div class="container">
            <div class="bookings-container">
                <h1>L·ªãch s·ª≠ ƒë·∫∑t v√©</h1>
                
                <!-- Filter Section -->
                <div class="filter-section">
                    <button class="filter-btn" data-filter="all">T·∫•t c·∫£</button>
                    <button class="filter-btn" data-filter="confirmed">X√°c nh·∫≠n</button>
                    <button class="filter-btn" data-filter="pending">Ch·ªù x·ª≠ l√Ω</button>
                    <button class="filter-btn" data-filter="cancelled">ƒê√£ h·ªßy</button>
                </div>

                <!-- Bookings List -->
                <div id="bookings-list" class="bookings-list"></div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>RAP PHIM</h4>
                    <p>H·ªá th·ªëng r·∫°p chi·∫øu phim hi·ªán ƒë·∫°i</p>
                </div>
                <div class="footer-section">
                    <h4>Li√™n k·∫øt</h4>
                    <ul>
                        <li><a href="#">Gi·ªõi thi·ªáu</a></li>
                        <li><a href="#">Li√™n h·ªá</a></li>
                        <li><a href="#">Tuy·ªÉn d·ª•ng</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Ch√≠nh s√°ch</h4>
                    <ul>
                        <li><a href="#">ƒêi·ªÅu kho·∫£n</a></li>
                        <li><a href="#">B·∫£o m·∫≠t</a></li>
                        <li><a href="#">Thanh to√°n</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Theo d√µi</h4>
                    <div class="social-links">
                        <a href="#" class="social-link">Facebook</a>
                        <a href="#" class="social-link">Instagram</a>
                        <a href="#" class="social-link">YouTube</a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 RAP PHIM. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="../js/api-client.js"></script>
    <script src="../js/bookings-client.js"></script>
    <script src="../js/storage.js"></script>
    <script src="../js/notification.js"></script>
    <script>
        let allBookings = [];
        let allMovies = [];
        let currentFilter = 'all';

        // Check if logged in
        window.addEventListener('DOMContentLoaded', () => {
            const user = Storage.getUser();
            if (!user) {
                Notification.error('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem l·ªãch s·ª≠ ƒë·∫∑t v√©');
                setTimeout(() => window.location.href = 'login.html', 1500);
                return;
            }
            
            updateAuthUI();
            loadData();
            setupFilterButtons();
        });

        async function loadData() {
            try {
                // Load movies first
                const moviesRes = await APIClient.getMovies();
                if (moviesRes.success) {
                    allMovies = moviesRes.data.movies || [];
                }
                
                // Then load bookings
                await loadBookings();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        async function loadBookings() {
            try {
                const user = Storage.getUser();
                if (!user || !user.id) {
                    throw new Error('Kh√¥ng t√¨m th·∫•y th√¥ng tin ng∆∞·ªùi d√πng');
                }

                const response = await BookingsClient.getUserBookings(user.id);

                if (response.success) {
                    allBookings = response.data.bookings || [];
                    displayBookings();
                } else {
                    showMessage(response.message || 'L·ªói khi t·∫£i d·ªØ li·ªáu', 'error');
                }
            } catch (error) {
                console.error('Error loading bookings:', error);
                showMessage('Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠ ƒë·∫∑t v√©', 'error');
            }
        }

        function updateAuthUI() {
            const user = Storage.getUser();
            const authBtn = document.getElementById('auth-btn');
            const userProfile = document.getElementById('user-profile');
            
            if (user) {
                authBtn.style.display = 'none';
                userProfile.style.display = 'flex';
                document.getElementById('username-display').textContent = user.username || user.user_id || 'User';
                document.getElementById('user-email-display').textContent = user.email || 'kh√°ch h√†ng';
            } else {
                authBtn.style.display = 'block';
                userProfile.style.display = 'none';
            }
        }

        function displayBookings() {
            const container = document.getElementById('bookings-list');
            
            const filteredBookings = currentFilter === 'all' 
                ? allBookings 
                : allBookings.filter(b => b.status === currentFilter);

            if (filteredBookings.length === 0) {
                container.innerHTML = '<p class="no-bookings">Kh√¥ng c√≥ ƒë·∫∑t v√© n√†o</p>';
                return;
            }

            container.innerHTML = filteredBookings.map(booking => {
                // Get current movie price from movies list
                const movie = allMovies.find(m => m.id == booking.movie_id);
                const currentPrice = movie ? movie.price : 0;
                const currentTotal = currentPrice * booking.total_seats;
                
                return `
                <div class="booking-card">
                    <div class="booking-poster">
                        <img src="${booking.poster_image || 'img/default-poster.jpg'}" alt="${booking.title}">
                    </div>
                    <div class="booking-details">
                        <h3 class="booking-title">${booking.title}</h3>
                        <div class="booking-info">
                            <p><strong>M√£ ƒë·∫∑t v√©:</strong> #${booking.id}</p>
                            <p><strong>Gh·∫ø:</strong> ${booking.seat_numbers ? booking.seat_numbers.join(', ') : booking.total_seats + ' gh·∫ø'}</p>
                            <p><strong>Gi√° khi ƒë·∫∑t:</strong> <span class="price">${formatPrice(booking.total_price)}</span></p>
                            <p><strong>Gi√° hi·ªán t·∫°i:</strong> <span class="price" style="color: #ffff00;">${formatPrice(currentTotal)}</span></p>
                            <p><strong>Ng√†y ƒë·∫∑t:</strong> ${formatDateTime(booking.booking_date)}</p>
                            <p><strong>Tr·∫°ng th√°i:</strong> <span class="status ${booking.status}">${getStatusText(booking.status)}</span></p>
                        </div>
                        <div class="booking-actions">
                            ${booking.status === 'confirmed' ? `
                                <button class="btn-cancel" onclick="cancelBooking(${booking.id})">H·ªßy ƒë·∫∑t v√©</button>
                            ` : ''}
                            <button class="btn-details" onclick="viewBookingDetails(${booking.id})">Chi ti·∫øt</button>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        function setupFilterButtons() {
            const buttons = document.querySelectorAll('.filter-btn');
            buttons.forEach(btn => {
                btn.addEventListener('click', function() {
                    buttons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.dataset.filter;
                    displayBookings();
                });
            });
            
            // Set first button as active
            if (buttons.length > 0) {
                buttons[0].classList.add('active');
            }
        }

        async function cancelBooking(bookingId) {
            Notification.confirm(
                'B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy ƒë·∫∑t v√© n√†y?',
                async () => {
                    try {
                        const response = await BookingsClient.cancelBooking(bookingId);
                        if (response.success) {
                            Notification.success('ƒê√£ h·ªßy ƒë·∫∑t v√© th√†nh c√¥ng');
                            await new Promise(r => setTimeout(r, 1000));
                            await loadBookings();
                        } else {
                            Notification.error(response.message || 'L·ªói khi h·ªßy ƒë·∫∑t v√©');
                        }
                    } catch (error) {
                        console.error('Error cancelling booking:', error);
                        Notification.error('Kh√¥ng th·ªÉ h·ªßy ƒë·∫∑t v√©');
                    }
                }
            );
        }

        function viewBookingDetails(bookingId) {
            const booking = allBookings.find(b => b.id === bookingId);
            if (booking) {
                const movie = allMovies.find(m => m.id == booking.movie_id);
                const currentPrice = movie ? movie.price : 0;
                const currentTotal = currentPrice * booking.total_seats;
                
                const seatInfo = booking.seat_numbers ? booking.seat_numbers.join(', ') : booking.total_seats + ' gh·∫ø';
                const details = `Chi ti·∫øt ƒë·∫∑t v√© #${booking.id}\n\nPhim: ${booking.title}\nGh·∫ø: ${seatInfo}\nGi√° khi ƒë·∫∑t: ${formatPrice(booking.total_price)}\nGi√° hi·ªán t·∫°i: ${formatPrice(currentTotal)}\nTr·∫°ng th√°i: ${getStatusText(booking.status)}`;
                Notification.info(details);
            }
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(price);
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${day}-${month}-${year} ${hours}:${minutes}`;
        }

        function getStatusText(status) {
            const statusMap = {
                'confirmed': 'X√°c nh·∫≠n',
                'pending': 'Ch·ªù x·ª≠ l√Ω',
                'cancelled': 'ƒê√£ h·ªßy'
            };
            return statusMap[status] || status;
        }

        function showMessage(message, type) {
            if (type === 'success') {
                Notification.success(message);
            } else {
                Notification.error(message);
            }
        }

        function handleAuthClick() {
            window.location.href = 'auth.html';
        }

        function handleLogout(event) {
            event.preventDefault();
            Storage.clear();
            updateAuthUI();
            window.location.href = 'index.html';
        }

        function toggleUserDropdown() {
            const dropdown = document.getElementById('user-dropdown');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const userSection = document.getElementById('user-profile');
            const dropdown = document.getElementById('user-dropdown');
            if (userSection && !userSection.contains(e.target)) {
                dropdown?.classList.remove('show');
            }
        });
    </script>
</body>
</html>
