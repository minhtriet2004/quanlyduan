<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L·ªãch s·ª≠ ƒë·∫∑t v√© - RAP PHIM</title>
    <link rel="stylesheet" href="/css/bookings-history.css">
    <link rel="stylesheet" href="/css/notification.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo" onclick="window.location.href = 'index.html'" style="cursor: pointer;">RAP PHIM</div>
                <nav class="nav">
                    <a href="index.html" class="nav-link">Trang ch·ªß</a>
                </nav>
                <button class="btn-login" id="auth-btn" onclick="handleAuthClick()">ƒêƒÉng nh·∫≠p</button>
                <div class="profile-menu" id="profile-menu" style="display: none;">
                    <div class="profile-header">
                        <div class="profile-avatar">üë§</div>
                        <div class="profile-info">
                            <p class="profile-name" id="profile-name"></p>
                            <p class="profile-email" id="profile-email"></p>
                        </div>
                    </div>
                    <a href="bookings-history.html" class="profile-link">L·ªãch s·ª≠ ƒë·∫∑t v√©</a>
                    <a href="#" class="profile-link" onclick="handleLogout(event)">ƒêƒÉng xu·∫•t</a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <div class="container">
            <div class="bookings-container">
                <h1>L·ªãch s·ª≠ ƒë·∫∑t v√©</h1>
                
                <!-- Filter Section -->
                <div class="filter-section">
                    <button class="filter-btn" data-filter="all">T·∫•t c·∫£</button>
                    <button class="filter-btn" data-filter="confirmed">X√°c nh·∫≠n</button>
                    <button class="filter-btn" data-filter="pending">Ch·ªù x·ª≠ l√Ω</button>
                    <button class="filter-btn" data-filter="cancelled">ƒê√£ h·ªßy</button>
                </div>

                <!-- Bookings List -->
                <div id="bookings-list" class="bookings-list"></div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>RAP PHIM</h4>
                    <p>H·ªá th·ªëng r·∫°p chi·∫øu phim hi·ªán ƒë·∫°i</p>
                </div>
                <div class="footer-section">
                    <h4>Li√™n k·∫øt</h4>
                    <ul>
                        <li><a href="#">Gi·ªõi thi·ªáu</a></li>
                        <li><a href="#">Li√™n h·ªá</a></li>
                        <li><a href="#">Tuy·ªÉn d·ª•ng</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Ch√≠nh s√°ch</h4>
                    <ul>
                        <li><a href="#">ƒêi·ªÅu kho·∫£n</a></li>
                        <li><a href="#">B·∫£o m·∫≠t</a></li>
                        <li><a href="#">Thanh to√°n</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Theo d√µi</h4>
                    <div class="social-links">
                        <a href="#" class="social-link">Facebook</a>
                        <a href="#" class="social-link">Instagram</a>
                        <a href="#" class="social-link">YouTube</a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 RAP PHIM. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="/js/api-client.js"></script>
    <script src="/js/bookings-client.js"></script>
    <script src="/js/storage.js"></script>
    <script src="/js/notification.js"></script>
    <script>
        let allBookings = [];
        let currentFilter = 'all';

        // Check if logged in
        window.addEventListener('DOMContentLoaded', () => {
            const user = Storage.getUser();
            if (!user) {
                Notification.error('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem l·ªãch s·ª≠ ƒë·∫∑t v√©');
                setTimeout(() => window.location.href = 'login.html', 1500);
                return;
            }
            
            updateAuthUI();
            loadBookings();
            setupFilterButtons();
        });

        function updateAuthUI() {
            const user = Storage.getUser();
            const authBtn = document.getElementById('auth-btn');
            const profileMenu = document.getElementById('profile-menu');
            
            if (user) {
                authBtn.style.display = 'none';
                profileMenu.style.display = 'block';
                document.getElementById('profile-name').textContent = user.username || user.name || 'User';
                document.getElementById('profile-email').textContent = user.email || '';
            } else {
                authBtn.style.display = 'block';
                profileMenu.style.display = 'none';
            }
        }

        async function loadBookings() {
            try {
                const user = Storage.getUser();
                if (!user || !user.id) {
                    throw new Error('Kh√¥ng t√¨m th·∫•y th√¥ng tin ng∆∞·ªùi d√πng');
                }

                const response = await BookingsClient.getUserBookings(user.id);

                if (response.success) {
                    allBookings = response.data.bookings || [];
                    displayBookings();
                } else {
                    showMessage(response.message || 'L·ªói khi t·∫£i d·ªØ li·ªáu', 'error');
                }
            } catch (error) {
                console.error('Error loading bookings:', error);
                showMessage('Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠ ƒë·∫∑t v√©', 'error');
            }
        }

        function displayBookings() {
            const container = document.getElementById('bookings-list');
            
            const filteredBookings = currentFilter === 'all' 
                ? allBookings 
                : allBookings.filter(b => b.status === currentFilter);

            if (filteredBookings.length === 0) {
                container.innerHTML = '<p class="no-bookings">Kh√¥ng c√≥ ƒë·∫∑t v√© n√†o</p>';
                return;
            }

            container.innerHTML = filteredBookings.map(booking => `
                <div class="booking-card">
                    <div class="booking-poster">
                        <img src="${booking.poster_image || '/img/default-poster.jpg'}" alt="${booking.title}">
                    </div>
                    <div class="booking-details">
                        <h3 class="booking-title">${booking.title}</h3>
                        <div class="booking-info">
                            <p><strong>M√£ ƒë·∫∑t v√©:</strong> #${booking.id}</p>
                            <p><strong>Gh·∫ø:</strong> ${booking.seat_numbers ? booking.seat_numbers.join(', ') : booking.total_seats + ' gh·∫ø'}</p>
                            <p><strong>T·ªïng ti·ªÅn:</strong> <span class="price">${formatPrice(booking.total_price)}</span></p>
                            <p><strong>Ng√†y ƒë·∫∑t:</strong> ${formatDateTime(booking.booking_date)}</p>
                            <p><strong>Tr·∫°ng th√°i:</strong> <span class="status ${booking.status}">${getStatusText(booking.status)}</span></p>
                        </div>
                        <div class="booking-actions">
                            ${booking.status === 'confirmed' ? `
                                <button class="btn-cancel" onclick="cancelBooking(${booking.id})">H·ªßy ƒë·∫∑t v√©</button>
                            ` : ''}
                            <button class="btn-details" onclick="viewBookingDetails(${booking.id})">Chi ti·∫øt</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function setupFilterButtons() {
            const buttons = document.querySelectorAll('.filter-btn');
            buttons.forEach(btn => {
                btn.addEventListener('click', function() {
                    buttons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.dataset.filter;
                    displayBookings();
                });
            });
            
            // Set first button as active
            if (buttons.length > 0) {
                buttons[0].classList.add('active');
            }
        }

        async function cancelBooking(bookingId) {
            Notification.confirm(
                'B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy ƒë·∫∑t v√© n√†y?',
                async () => {
                    try {
                        const response = await BookingsClient.cancelBooking(bookingId);
                        if (response.success) {
                            Notification.success('ƒê√£ h·ªßy ƒë·∫∑t v√© th√†nh c√¥ng');
                            await new Promise(r => setTimeout(r, 1000));
                            await loadBookings();
                        } else {
                            Notification.error(response.message || 'L·ªói khi h·ªßy ƒë·∫∑t v√©');
                        }
                    } catch (error) {
                        console.error('Error cancelling booking:', error);
                        Notification.error('Kh√¥ng th·ªÉ h·ªßy ƒë·∫∑t v√©');
                    }
                }
            );
        }

        function viewBookingDetails(bookingId) {
            const booking = allBookings.find(b => b.id === bookingId);
            if (booking) {
                const seatInfo = booking.seat_numbers ? booking.seat_numbers.join(', ') : booking.total_seats + ' gh·∫ø';
                const details = `Chi ti·∫øt ƒë·∫∑t v√© #${booking.id}\n\nPhim: ${booking.title}\nGh·∫ø: ${seatInfo}\nT·ªïng ti·ªÅn: ${formatPrice(booking.total_price)}\nTr·∫°ng th√°i: ${getStatusText(booking.status)}`;
                Notification.info(details);
            }
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(price);
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${day}-${month}-${year} ${hours}:${minutes}`;
        }

        function getStatusText(status) {
            const statusMap = {
                'confirmed': 'X√°c nh·∫≠n',
                'pending': 'Ch·ªù x·ª≠ l√Ω',
                'cancelled': 'ƒê√£ h·ªßy'
            };
            return statusMap[status] || status;
        }

        function showMessage(message, type) {
            if (type === 'success') {
                Notification.success(message);
            } else {
                Notification.error(message);
            }
        }

        function handleAuthClick() {
            window.location.href = 'login.html';
        }

        function handleLogout(event) {
            event.preventDefault();
            Storage.clear();
            updateAuthUI();
            window.location.href = 'index.html';
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const authBtn = document.getElementById('auth-btn');
            const profileMenu = document.getElementById('profile-menu');
            if (!event.target.closest('.btn-login') && !event.target.closest('.profile-menu')) {
                profileMenu.style.display = 'none';
            }
        });
    </script>
</body>
</html>
