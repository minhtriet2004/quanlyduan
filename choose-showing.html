<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ch·ªçn Su·∫•t Chi·∫øu</title>
    <link rel="stylesheet" href="css/choose-seat.css">
    <link rel="stylesheet" href="css/notification.css">
</head>
<body>
    <div class="movie-container">
        <label>Ch·ªçn su·∫•t chi·∫øu cho phim:</label>
        <h2 id="movieName" style="color:white; margin-top:5px;"></h2>
        
        <p id="ticketQuantity" style="color:#00b7ff; margin-top:10px; font-size:16px;"></p>

        <div style="margin-top: 30px;">
            <div id="showingsContainer" style="display: flex; flex-direction: row; gap: 20px; overflow-x: auto; padding-bottom: 20px; scroll-behavior: smooth;">
                <p style="color: white; text-align: center; width: 100%;">ƒêang t·∫£i su·∫•t chi·∫øu...</p>
            </div>
            <style>
                #showingsContainer::-webkit-scrollbar {
                    height: 8px;
                }
                #showingsContainer::-webkit-scrollbar-track {
                    background: rgba(0, 183, 255, 0.1);
                    border-radius: 10px;
                }
                #showingsContainer::-webkit-scrollbar-thumb {
                    background: #00b7ff;
                    border-radius: 10px;
                }
                #showingsContainer::-webkit-scrollbar-thumb:hover {
                    background: #0099cc;
                }
            </style>
        </div>
    </div>

    <script src="js/api-client.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/notification.js"></script>
    <script>
        let movieId = null;
        let selectedRoom = null;
        let requiredQuantity = 0;
        let currentMovie = null;

        window.addEventListener('DOMContentLoaded', () => {
            loadShowingSelection();
        });

        async function loadShowingSelection() {
            const params = new URLSearchParams(window.location.search);
            movieId = params.get('id');
            selectedRoom = parseInt(params.get('room')) || null;

            if (!movieId) {
                Notification.error('Kh√¥ng t√¨m th·∫•y phim');
                setTimeout(() => window.location.href = 'index.html', 1500);
                return;
            }

            // Get booking info from session storage
            const bookingInfo = JSON.parse(sessionStorage.getItem('bookingInfo') || '{}');
            requiredQuantity = parseInt(bookingInfo.quantity) || 0;

            if (requiredQuantity === 0) {
                Notification.error('Kh√¥ng t√¨m th·∫•y th√¥ng tin s·ªë l∆∞·ª£ng v√©');
                setTimeout(() => window.location.href = 'index.html', 1500);
                return;
            }

            try {
                // Load movie info
                const movieRes = await APIClient.getMovieById(movieId);
                if (movieRes.success) {
                    currentMovie = movieRes.data.movie;
                    document.getElementById('movieName').textContent = currentMovie.title || 'Kh√¥ng x√°c ƒë·ªãnh';
                    document.getElementById('ticketQuantity').textContent = `B·∫°n c·∫ßn ch·ªçn ${requiredQuantity} gh·∫ø${selectedRoom ? ` - Ph√≤ng ${selectedRoom}` : ''}`;
                }

                // Load showings
                const showingsRes = await APIClient.getShowings(movieId);
                if (showingsRes.success) {
                    let showings = showingsRes.data.showings || [];
                    
                    // Filter showings by selected room
                    if (selectedRoom) {
                        showings = showings.filter(s => s.room_number === selectedRoom);
                    }
                    
                    if (showings.length === 0) {
                        document.getElementById('showingsContainer').innerHTML = '<p style="color: red; grid-column: 1/-1; text-align: center;">Kh√¥ng c√≥ su·∫•t chi·∫øu n√†o cho ph√≤ng n√†y</p>';
                        return;
                    }

                    displayShowings(showings);
                } else {
                    Notification.error('Kh√¥ng th·ªÉ t·∫£i danh s√°ch su·∫•t chi·∫øu');
                }
            } catch (error) {
                console.error('Error loading showings:', error);
                Notification.error('L·ªói khi t·∫£i su·∫•t chi·∫øu');
            }
        }

        function displayShowings(showings) {
            const container = document.getElementById('showingsContainer');
            
            container.innerHTML = showings.map(showing => {
                // Parse date
                const showingDate = showing.showing_date || '';
                const showingTime = showing.showing_time || '';
                
                let formattedDate = showingDate;
                if (showingDate) {
                    const dateParts = showingDate.split('-');
                    if (dateParts.length === 3) {
                        formattedDate = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
                    }
                }
                
                let formattedTime = showingTime;
                if (showingTime) {
                    formattedTime = showingTime.substring(0, 5);
                }

                const price = parseFloat(showing.price) || 0;
                const totalPrice = price * requiredQuantity;
                
                return `
                    <div style="
                        background: linear-gradient(135deg, #1a1f3a 0%, #222849 100%);
                        border: 1px solid rgba(0, 183, 255, 0.3);
                        border-radius: 12px;
                        padding: 20px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        min-width: 320px;
                        flex-shrink: 0;
                    " 
                    onmouseover="this.style.borderColor='#00b7ff'; this.style.transform='translateY(-5px)'"
                    onmouseout="this.style.borderColor='rgba(0, 183, 255, 0.3)'; this.style.transform='translateY(0)'"
                    onclick="selectShowing(${showing.id})">
                        <div style="color: #00b7ff; font-size: 14px; margin-bottom: 10px;">
                            üé¨ Ph√≤ng: ${showing.room_number}
                        </div>
                        <div style="color: #fff; font-size: 18px; font-weight: bold; margin-bottom: 10px;">
                            üìÖ ${formattedDate} l√∫c üïê ${formattedTime}
                        </div>
                        <div style="color: #cfd3ff; font-size: 14px; margin-bottom: 15px;">
                            Gh·∫ø c√≤n tr·ªëng: <span style="color: #00b7ff; font-weight: bold;">${showing.available_seats}</span>
                        </div>
                        <div style="
                            background: rgba(0, 183, 255, 0.1);
                            padding: 12px;
                            border-radius: 8px;
                            text-align: center;
                        ">
                            <div style="color: #a8aeff; font-size: 12px; margin-bottom: 5px;">T·ªïng gi√° cho ${requiredQuantity} gh·∫ø:</div>
                            <div style="color: #ffff00; font-size: 20px; font-weight: bold;">
                                ${formatPrice(totalPrice)}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectShowing(showingId) {
            // Save showing_id to session storage
            const bookingInfo = JSON.parse(sessionStorage.getItem('bookingInfo') || '{}');
            bookingInfo.showing_id = showingId;
            sessionStorage.setItem('bookingInfo', JSON.stringify(bookingInfo));
            
            // Redirect to choose-seat (ch·ªçn gh·∫ø)
            window.location.href = `choose-seat.html?id=${movieId}&showing_id=${showingId}`;
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN', { 
                style: 'currency', 
                currency: 'VND',
                minimumFractionDigits: 0 
            }).format(price);
        }
    </script>
</body>
</html>
